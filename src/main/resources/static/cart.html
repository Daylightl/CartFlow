<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è´­ç‰©è½¦ - CartFlow</title>
    <link rel="stylesheet" href="/css/common.css">
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar">
        <div class="navbar-container">
            <a href="/index.html" class="navbar-brand">CartFlow</a>
            <div class="navbar-menu">
                <a href="/index.html">é¦–é¡µ</a>
                <a href="/product-list.html">å•†å“åˆ—è¡¨</a>
            </div>
            <div class="navbar-user" id="navbar-user"></div>
        </div>
    </nav>

    <!-- ä¸»å®¹å™¨ -->
    <div class="container">
        <div class="card">
            <div class="d-flex justify-between align-center mb-20">
                <h2 class="card-header" style="margin: 0;">è´­ç‰©è½¦</h2>
                <button class="btn btn-danger" onclick="clearCart()">æ¸…ç©ºè´­ç‰©è½¦</button>
            </div>

            <div id="cart-content"></div>

            <div id="cart-summary" style="display: none;">
                <div style="margin-top: 30px; padding-top: 20px; border-top: 2px solid #f0f0f0;">
                    <div class="d-flex justify-between align-center">
                        <div>
                            <span style="font-size: 18px; color: #606266;">æ€»è®¡ï¼š</span>
                            <span id="total-price" style="font-size: 28px; color: #F56C6C; font-weight: bold;"></span>
                        </div>
                        <button class="btn btn-success" onclick="checkout()"
                                style="padding: 15px 40px; font-size: 16px;">
                            å»ç»“ç®—
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="/js/common.js"></script>
    <script>
        let cart = null;

        // åŠ è½½è´­ç‰©è½¦
        async function loadCart() {
            if (!requireLogin()) return;

            try {
                const result = await get(`${API_BASE}/cart`);
                if (result.success) {
                    cart = result.data;
                    renderCart();
                }
            } catch (error) {
                console.error('åŠ è½½è´­ç‰©è½¦å¤±è´¥:', error);
                showMessage('åŠ è½½è´­ç‰©è½¦å¤±è´¥', 'error');
            }
        }

        // æ¸²æŸ“è´­ç‰©è½¦
        function renderCart() {
            const container = document.getElementById('cart-content');
            const summary = document.getElementById('cart-summary');

            if (!cart || cart.items.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ›’</div>
                        <p class="empty-state-text">è´­ç‰©è½¦æ˜¯ç©ºçš„</p>
                        <button class="btn btn-primary" onclick="window.location.href='/product-list.html'">
                            å»è´­ç‰©
                        </button>
                    </div>
                `;
                summary.style.display = 'none';
                return;
            }

            // æ¸²æŸ“è´­ç‰©è½¦è¡¨æ ¼
            container.innerHTML = `
                <table class="table">
                    <thead>
                        <tr>
                            <th>å•†å“ä¿¡æ¯</th>
                            <th>å•ä»·</th>
                            <th>æ•°é‡</th>
                            <th>å°è®¡</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${cart.items.map(item => `
                            <tr>
                                <td>${item.productName}</td>
                                <td>${formatPrice(item.price)}</td>
                                <td>
                                    <div style="display: flex; align-items: center; gap: 5px;">
                                        <button class="btn btn-secondary" onclick="updateQuantity(${item.productId}, ${item.quantity - 1})">-</button>
                                        <input type="number" value="${item.quantity}" min="1"
                                               style="width: 60px; text-align: center; padding: 5px; border: 1px solid #dcdfe6; border-radius: 4px;"
                                               onchange="updateQuantity(${item.productId}, this.value)">
                                        <button class="btn btn-secondary" onclick="updateQuantity(${item.productId}, ${item.quantity + 1})">+</button>
                                    </div>
                                </td>
                                <td style="font-weight: bold; color: #F56C6C;">${formatPrice(item.price * item.quantity)}</td>
                                <td>
                                    <button class="btn btn-danger" onclick="removeItem(${item.productId})">åˆ é™¤</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            // æ˜¾ç¤ºæ€»ä»·
            summary.style.display = 'block';
            document.getElementById('total-price').textContent = formatPrice(cart.totalPrice);
        }

        // æ›´æ–°æ•°é‡
        async function updateQuantity(productId, quantity) {
            quantity = parseInt(quantity);
            if (quantity < 0) return;

            try {
                const result = await put(`${API_BASE}/cart/update`, {
                    productId: productId,
                    quantity: quantity
                });

                if (result.success) {
                    cart = result.data;
                    renderCart();
                } else {
                    showMessage(result.message || 'æ›´æ–°å¤±è´¥', 'error');
                    loadCart();
                }
            } catch (error) {
                console.error('æ›´æ–°æ•°é‡å¤±è´¥:', error);
                showMessage('æ›´æ–°å¤±è´¥', 'error');
            }
        }

        // åˆ é™¤å•†å“
        async function removeItem(productId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä»¶å•†å“å—ï¼Ÿ')) return;

            try {
                const result = await del(`${API_BASE}/cart/remove`, {
                    productId: productId
                });

                if (result.success) {
                    cart = result.data;
                    renderCart();
                    showMessage('åˆ é™¤æˆåŠŸ', 'success');
                } else {
                    showMessage(result.message || 'åˆ é™¤å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('åˆ é™¤å¤±è´¥:', error);
                showMessage('åˆ é™¤å¤±è´¥', 'error');
            }
        }

        // æ¸…ç©ºè´­ç‰©è½¦
        async function clearCart() {
            if (!confirm('ç¡®å®šè¦æ¸…ç©ºè´­ç‰©è½¦å—ï¼Ÿ')) return;

            try {
                const result = await del(`${API_BASE}/cart/clear`);
                if (result.success) {
                    showMessage('è´­ç‰©è½¦å·²æ¸…ç©º', 'success');
                    loadCart();
                }
            } catch (error) {
                console.error('æ¸…ç©ºå¤±è´¥:', error);
                showMessage('æ¸…ç©ºå¤±è´¥', 'error');
            }
        }

        // å»ç»“ç®—
        function checkout() {
            const address = prompt('è¯·è¾“å…¥æ”¶è´§åœ°å€ï¼š');
            if (!address || !address.trim()) {
                showMessage('è¯·è¾“å…¥æ”¶è´§åœ°å€', 'warning');
                return;
            }

            createOrder(address.trim());
        }

        // åˆ›å»ºè®¢å•
        async function createOrder(address) {
            try {
                const result = await post(`${API_BASE}/orders/create`, {
                    address: address
                });

                if (result.success) {
                    showMessage('è®¢å•åˆ›å»ºæˆåŠŸï¼', 'success');
                    setTimeout(() => {
                        window.location.href = '/order-detail.html?id=' + result.orderId;
                    }, 1000);
                } else {
                    showMessage(result.message || 'è®¢å•åˆ›å»ºå¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('åˆ›å»ºè®¢å•å¤±è´¥:', error);
                showMessage('åˆ›å»ºè®¢å•å¤±è´¥', 'error');
            }
        }

        // é¡µé¢åŠ è½½
        document.addEventListener('DOMContentLoaded', function() {
            loadCart();
        });
    </script>
</body>
</html>
