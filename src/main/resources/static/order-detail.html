<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>订单详情 - CartFlow</title>
    <link rel="stylesheet" href="/css/common.css">
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar">
        <div class="navbar-container">
            <a href="/index.html" class="navbar-brand">CartFlow</a>
            <div class="navbar-menu">
                <a href="/index.html">首页</a>
                <a href="/product-list.html">商品列表</a>
            </div>
            <div class="navbar-user" id="navbar-user"></div>
        </div>
    </nav>

    <!-- 主容器 -->
    <div class="container">
        <div class="card">
            <div class="d-flex justify-between align-center mb-20">
                <h2 class="card-header" style="margin: 0;">订单详情</h2>
                <button class="btn btn-secondary" onclick="window.history.back()">返回</button>
            </div>
            <div id="order-detail"></div>
        </div>
    </div>

    <script src="/js/common.js"></script>
    <script>
        let order = null;

        // 加载订单详情
        async function loadOrderDetail() {
            if (!requireLogin()) return;

            const orderId = getUrlParam('id');
            if (!orderId) {
                showMessage('订单不存在', 'error');
                setTimeout(() => window.location.href = '/order-list.html', 1000);
                return;
            }

            try {
                const result = await get(`${API_BASE}/orders/${orderId}`);
                if (result.success) {
                    order = result.data;
                    renderOrderDetail();
                } else {
                    showMessage(result.message || '订单不存在', 'error');
                    setTimeout(() => window.location.href = '/order-list.html', 1000);
                }
            } catch (error) {
                console.error('加载订单详情失败:', error);
                showMessage('加载失败', 'error');
            }
        }

        // 渲染订单详情
        function renderOrderDetail() {
            if (!order) return;

            const container = document.getElementById('order-detail');
            container.innerHTML = `
                <div style="background-color: #f5f7fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <div class="d-flex justify-between align-center mb-15">
                        <div>
                            <h3>订单号：${order.orderId}</h3>
                        </div>
                        <div>
                            ${getStatusBadge(order.status)}
                        </div>
                    </div>
                    <div class="mb-10">
                        <strong>下单时间：</strong>${order.createTime}
                    </div>
                    ${order.address ? `
                        <div class="mb-10">
                            <strong>收货地址：</strong>${order.address}
                        </div>
                    ` : ''}
                </div>

                <h3 style="margin-bottom: 15px;">商品清单</h3>
                <table class="table">
                    <thead>
                        <tr>
                            <th>商品名称</th>
                            <th>单价</th>
                            <th>数量</th>
                            <th>小计</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${order.items.map(item => `
                            <tr>
                                <td>${item.productName}</td>
                                <td>${formatPrice(item.price)}</td>
                                <td>${item.quantity}</td>
                                <td style="font-weight: bold; color: #F56C6C;">${formatPrice(item.price * item.quantity)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>

                <div style="margin-top: 30px; padding-top: 20px; border-top: 2px solid #f0f0f0;">
                    <div class="d-flex justify-between align-center">
                        <div>
                            ${order.status === 'pending' ? `
                                <button class="btn btn-danger" onclick="cancelOrder()">取消订单</button>
                            ` : ''}
                        </div>
                        <div>
                            <span style="font-size: 18px; color: #606266;">订单总额：</span>
                            <span style="font-size: 28px; color: #F56C6C; font-weight: bold;">
                                ${formatPrice(order.totalAmount)}
                            </span>
                        </div>
                    </div>
                </div>
            `;
        }

        // 获取状态徽章
        function getStatusBadge(status) {
            const statusMap = {
                'pending': { text: '待发货', color: '#E6A23C' },
                'shipped': { text: '已发货', color: '#409EFF' },
                'completed': { text: '已完成', color: '#67C23A' },
                'cancelled': { text: '已取消', color: '#909399' }
            };

            const statusInfo = statusMap[status] || { text: '未知', color: '#909399' };
            return `<span style="padding: 5px 15px; background-color: ${statusInfo.color}; color: white; border-radius: 4px;">
                ${statusInfo.text}
            </span>`;
        }

        // 取消订单
        async function cancelOrder() {
            if (!confirm('确定要取消这个订单吗？')) return;

            try {
                const result = await post(`${API_BASE}/orders/${order.orderId}/cancel`, {});
                if (result.success) {
                    showMessage('订单已取消', 'success');
                    loadOrderDetail();
                } else {
                    showMessage(result.message || '取消失败', 'error');
                }
            } catch (error) {
                console.error('取消订单失败:', error);
                showMessage('取消失败', 'error');
            }
        }

        // 页面加载
        document.addEventListener('DOMContentLoaded', function() {
            loadOrderDetail();
        });
    </script>
</body>
</html>
